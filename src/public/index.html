<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Hikvision</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .scale-enter-active, .scale-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .scale-enter-from, .scale-leave-to { opacity: 0; transform: scale(0.95); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        [v-cloak] { display: none; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <div id="app" v-cloak class="min-h-screen flex flex-col">

        <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm backdrop-blur-md bg-white/90">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm shadow-indigo-200">
                            <i class="fa-solid fa-fingerprint text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-slate-800 tracking-tight leading-none">Acceso ICG</h1>
                            <span class="text-xs text-slate-500 font-medium">Gesti√≥n Hikvision</span>
                        </div>
                    </div>
                    <button @click="sincronizarTodo" :disabled="loadingSync"
                        class="group relative inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white transition-all duration-200 bg-indigo-600 border border-transparent rounded-lg shadow-sm hover:bg-indigo-700 hover:shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-70 disabled:cursor-not-allowed">
                        <i :class="loadingSync ? 'fa-spin' : 'group-hover:rotate-180 transition-transform duration-500'"
                            class="fa-solid fa-sync mr-2"></i>
                        {{ loadingSync ? 'Sincronizando...' : 'Sincronizar Todo' }}
                    </button>
                </div>
            </div>
        </nav>

        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8 transition-all hover:shadow-md">
                <label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Buscar Cliente</label>
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-search text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <input v-model="busqueda" type="text"
                        class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all shadow-sm"
                        placeholder="Escribe nombre, c√≥digo o identificaci√≥n...">
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">C√≥digo ID</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Vigencia</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">Tarjetas</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            <tr v-for="c in clientesPaginados" :key="c.CODCLIENTE" @click="abrirModal(c)"
                                class="hover:bg-indigo-50/50 cursor-pointer transition-colors duration-150 group">

                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 border border-slate-300 flex items-center justify-center text-slate-600 font-bold text-sm shadow-sm group-hover:from-indigo-100 group-hover:to-indigo-200 group-hover:text-indigo-700 transition-all">
                                                {{ obtenerIniciales(c.NOMBRECLIENTE) }}
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-semibold text-slate-900">{{ c.NOMBRECLIENTE }}</div>
                                            <div class="text-xs text-slate-500">Usuario Regular</div>
                                        </div>
                                    </div>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200 font-mono">
                                        #{{ c.CODCLIENTE }}
                                    </span>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="estaVigente(c.FECHAFINPLAN) ? 'bg-emerald-100 text-emerald-800 border-emerald-200 ring-emerald-500/20' : 'bg-rose-100 text-rose-800 border-rose-200 ring-rose-500/20'"
                                        class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full border ring-1 ring-inset items-center gap-1.5">
                                        <i :class="estaVigente(c.FECHAFINPLAN) ? 'fa-check-circle' : 'fa-times-circle'" class="fa-solid"></i>
                                        {{ estaVigente(c.FECHAFINPLAN) ? formatearFecha(c.FECHAFINPLAN) : 'Vencido' }}
                                    </span>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <div v-if="c.loadingCards" class="text-indigo-400">
                                        <i class="fa-solid fa-circle-notch fa-spin text-sm"></i>
                                    </div>
                                    <div v-else-if="c.tarjetasDispositivo !== undefined" class="text-sm font-medium">
                                        <span v-if="c.tarjetasDispositivo.length > 0" class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md border border-indigo-100">
                                            <i class="fa-solid fa-wifi text-xs mr-1"></i>
                                            {{ c.tarjetasDispositivo.length }}
                                        </span>
                                        <span v-else class="text-slate-300 text-xs italic">Ninguna</span>
                                    </div>
                                    <div v-else class="text-slate-300 text-xs">
                                        <i class="fa-solid fa-hourglass-start"></i>
                                    </div>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button class="text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 p-2 rounded-full transition-all">
                                        <i class="fa-solid fa-pen-to-square text-lg"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div v-if="clientesPaginados.length === 0 && !cargandoDatos" class="p-16 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4 text-slate-400">
                            <i class="fa-solid fa-users-slash text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-slate-900">No se encontraron clientes</h3>
                        <p class="text-slate-500 mt-1 max-w-sm mx-auto">Intenta buscar por otro nombre o c√≥digo.</p>
                    </div>
                </div>
            </div>

            <div class="mt-4 px-2 flex items-center justify-between border-t border-slate-200 pt-4" v-if="clientes.length > 0">
                <div class="text-sm text-slate-500">
                    Mostrando <span class="font-medium">{{ ((paginaActual - 1) * itemsPorPagina) + 1 }}</span> a 
                    <span class="font-medium">{{ Math.min(paginaActual * itemsPorPagina, clientesResultadosBusqueda.length) }}</span> 
                    de <span class="font-medium">{{ clientesResultadosBusqueda.length }}</span> resultados
                </div>

                <div class="flex items-center gap-2">
                    <button @click="cambiarPagina(paginaActual - 1)" :disabled="paginaActual === 1"
                        class="px-3 py-1 rounded-md border border-slate-300 text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <i class="fa-solid fa-chevron-left mr-1"></i> Anterior
                    </button>
                    <span class="text-sm font-medium text-slate-700 bg-slate-100 px-3 py-1 rounded-md">
                        P√°g. {{ paginaActual }} de {{ totalPaginas }}
                    </span>
                    <button @click="cambiarPagina(paginaActual + 1)" :disabled="paginaActual === totalPaginas"
                        class="px-3 py-1 rounded-md border border-slate-300 text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        Siguiente <i class="fa-solid fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </main>

        <transition name="fade">
            <div v-if="clienteSeleccionado" class="fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @click="cerrarModal"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                    <transition name="scale">
                        <div v-if="clienteSeleccionado"
                            class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full ring-1 ring-black/5">

                            <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 px-6 py-5 relative overflow-hidden">
                                <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 rounded-full bg-white/10 blur-xl"></div>
                                <div class="flex justify-between items-start relative z-10">
                                    <div>
                                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                            {{ clienteSeleccionado.NOMBRECLIENTE }}
                                        </h3>
                                        <p class="mt-1 text-indigo-100 text-sm font-medium opacity-90">ID: {{ clienteSeleccionado.CODCLIENTE }}</p>
                                    </div>
                                    <button @click="cerrarModal" class="text-white/70 hover:text-white bg-white/10 hover:bg-white/20 rounded-lg p-1.5 transition-all">
                                        <i class="fa-solid fa-xmark text-lg"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="px-6 py-6 space-y-6 bg-white">

                                <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-sm relative">
                                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-camera text-indigo-500"></i> Foto de Rostro
                                    </h4>

                                    <div class="flex justify-center mb-5" v-if="!fotoDetectada && !esperandoRostro">
                                        <div class="relative group">
                                            <div class="w-32 h-32 rounded-full border-4 border-white shadow-md overflow-hidden bg-slate-200 flex items-center justify-center">
                                                <img v-if="fotoActualUrl" :src="fotoActualUrl" class="w-full h-full object-cover">
                                                <i v-else class="fa-solid fa-user text-4xl text-slate-300"></i>
                                            </div>

                                            <button v-if="fotoActualUrl" @click="borrarFoto" 
                                                class="absolute top-0 right-0 bg-red-500 text-white p-1.5 rounded-full shadow-sm hover:bg-red-600 transition-all transform hover:scale-105"
                                                title="Eliminar foto actual">
                                                <i class="fa-solid fa-trash-can text-xs"></i>
                                            </button>
                                            
                                            <div v-if="fotoActualUrl" class="absolute bottom-0 inset-x-0 text-center">
                                                <span class="bg-green-500 text-white text-[9px] px-2 py-0.5 rounded-full shadow-sm font-bold tracking-wide">REGISTRADO</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3 mb-4" v-if="!esperandoRostro && !fotoDetectada">
                                        <label class="cursor-pointer border border-slate-300 bg-white rounded-lg p-3 flex flex-col items-center justify-center hover:bg-slate-50 transition-all group">
                                            <i class="fa-solid fa-cloud-arrow-up text-xl text-slate-400 group-hover:text-indigo-500 mb-1"></i>
                                            <span class="text-[10px] font-medium text-slate-600">Subir Archivo</span>
                                            <input type="file" ref="fileInput" accept="image/jpeg" class="hidden" @change="subirFotoArchivo">
                                        </label>

                                        <button @click="iniciarCapturaAlPaso"
                                            class="border border-indigo-200 bg-indigo-50 rounded-lg p-3 flex flex-col items-center justify-center hover:bg-indigo-100 transition-all">
                                            <i class="fa-solid fa-eye text-xl text-indigo-600 mb-1"></i>
                                            <span class="text-[10px] font-bold text-indigo-700">Capturar al Paso</span>
                                        </button>
                                    </div>

                                    <div v-if="esperandoRostro" class="text-center py-6 bg-white rounded-lg border-2 border-indigo-100 border-dashed animate-pulse">
                                        <div class="mb-3">
                                            <span class="relative flex h-12 w-12 mx-auto">
                                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                                <span class="relative inline-flex rounded-full h-12 w-12 bg-indigo-500 items-center justify-center text-white">
                                                    <i class="fa-solid fa-user"></i>
                                                </span>
                                            </span>
                                        </div>
                                        <h5 class="text-sm font-bold text-indigo-900">Esperando Cliente...</h5>
                                        <p class="text-xs text-indigo-500 mt-1">P√≠dale que mire a la c√°mara ahora</p>
                                        <button @click="cancelarEspera" class="mt-4 text-xs text-slate-400 underline hover:text-slate-600">Cancelar</button>
                                    </div>

                                    <div v-if="fotoDetectada" class="text-center">
                                        <div class="relative w-32 h-32 mx-auto rounded-lg overflow-hidden border-2 border-green-500 shadow-md mb-3">
                                            <img :src="fotoDetectada.url" class="w-full h-full object-cover">
                                            <div class="absolute bottom-0 w-full bg-green-500 text-white text-[9px] py-0.5">¬°DETECTADO!</div>
                                        </div>
                                        <div class="flex gap-2 justify-center">
                                            <button @click="fotoDetectada = null" class="px-3 py-1.5 text-xs border rounded hover:bg-slate-50">Descartar</button>
                                            <button @click="guardarFotoDetectada" class="px-3 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700 shadow-sm">
                                                <i class="fa-solid fa-check mr-1"></i> Usar esta Foto
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-sm relative">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                            <i class="fa-regular fa-id-card text-indigo-500"></i> Tarjetas RFID
                                        </h4>
                                        <span :class="(clienteSeleccionado.tarjetas && clienteSeleccionado.tarjetas.length >= 5) ? 'bg-amber-100 text-amber-800' : 'bg-indigo-100 text-indigo-800'"
                                            class="text-[10px] px-2 py-0.5 rounded-full font-bold border border-black/5">
                                            {{ clienteSeleccionado.tarjetas ? clienteSeleccionado.tarjetas.length : 0 }} / 5
                                        </span>
                                    </div>

                                    <div class="flex gap-2 mb-4">
                                        <div class="relative flex-grow">
                                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fa-solid fa-barcode text-slate-400"></i></span>
                                            <input v-model="tarjetaInput" @keyup.enter="vincularTarjeta" type="text"
                                                placeholder="Escanear tarjeta..."
                                                :disabled="clienteSeleccionado.tarjetas && clienteSeleccionado.tarjetas.length >= 5"
                                                class="w-full border border-slate-300 pl-9 p-2.5 rounded-lg outline-none text-sm font-mono disabled:bg-slate-100">
                                        </div>
                                        <button @click="vincularTarjeta"
                                            :disabled="!tarjetaInput || (clienteSeleccionado.tarjetas && clienteSeleccionado.tarjetas.length >= 5)"
                                            class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition-all shadow-sm">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>
                                    </div>

                                    <div v-if="cargandoTarjetas" class="flex flex-col items-center justify-center py-8 text-indigo-500 bg-white rounded-lg border border-slate-100">
                                        <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i>
                                        <span class="text-xs font-medium text-slate-500">Leyendo dispositivo...</span>
                                    </div>

                                    <div v-else-if="clienteSeleccionado.tarjetas && clienteSeleccionado.tarjetas.length > 0"
                                        class="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                        <div v-for="(card, index) in clienteSeleccionado.tarjetas" :key="index"
                                            class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200 shadow-sm group hover:border-indigo-200">
                                            <div class="flex items-center gap-3">
                                                <div class="bg-indigo-50 text-indigo-600 w-8 h-8 rounded-md flex items-center justify-center text-xs">
                                                    <i class="fa-solid fa-wifi"></i>
                                                </div>
                                                <span class="font-mono text-sm font-semibold text-slate-700 tracking-wide">{{ card }}</span>
                                            </div>
                                            <button @click="eliminarTarjeta(card)" class="text-slate-300 hover:text-rose-500 hover:bg-rose-50 w-8 h-8 rounded-md transition-all flex items-center justify-center">
                                                <i class="fa-regular fa-trash-can"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div v-else class="text-center py-6 text-slate-400 bg-white border border-dashed border-slate-200 rounded-lg">
                                        <i class="fa-solid fa-id-card-clip text-2xl mb-2 opacity-30"></i>
                                        <p class="text-xs">Sin tarjetas asignadas</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-50 px-6 py-4 flex justify-end border-t border-slate-100">
                                <button @click="cerrarModal" class="bg-white border border-slate-300 text-slate-700 font-medium py-2 px-5 rounded-lg hover:bg-slate-50 text-sm shadow-sm">Cerrar</button>
                            </div>
                        </div>
                    </transition>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    clientes: [],
                    busqueda: '',
                    clienteSeleccionado: null,
                    tarjetaInput: '',
                    loadingSync: false,
                    cargandoTarjetas: false,
                    cargandoDatos: true,
                    paginaActual: 1,
                    itemsPorPagina: 50,

                    // VARIABLES FOTO (CAPTURA AL PASO)
                    esperandoRostro: false,
                    fotoDetectada: null,
                    fotoActualUrl: null, // NUEVO: Para visualizar la foto actual del cliente
                    pollingInterval: null
                }
            },
            computed: {
                clientesResultadosBusqueda() {
                    const term = this.busqueda.toLowerCase();
                    return this.clientes.filter(c =>
                        String(c.NOMBRECLIENTE).toLowerCase().includes(term) ||
                        String(c.CODCLIENTE).includes(term)
                    );
                },
                totalPaginas() {
                    return Math.ceil(this.clientesResultadosBusqueda.length / this.itemsPorPagina) || 1;
                },
                clientesPaginados() {
                    const inicio = (this.paginaActual - 1) * this.itemsPorPagina;
                    const fin = inicio + this.itemsPorPagina;
                    return this.clientesResultadosBusqueda.slice(inicio, fin);
                }
            },
            watch: {
                busqueda() {
                    this.paginaActual = 1;
                },
                clientesPaginados: {
                    handler(nuevos) {
                        this.cargarEstadoTarjetasVista(nuevos)
                    },
                    deep: false,
                    immediate: true
                }
            },
            mounted() {
                this.cargarClientes();
            },
            methods: {
                async cargarClientes() {
                    try {
                        const res = await fetch('/api/clientes');
                        if (!res.ok) throw new Error("Error en servidor: " + res.status);
                        const data = await res.json();
                        this.clientes = data.map(c => ({
                            ...c,
                            tarjetas: [],
                            tarjetasDispositivo: undefined,
                            loadingCards: false
                        }));
                    } catch (e) {
                        console.error("Error cargando clientes", e);
                        alert("‚ö†Ô∏è Error de conexi√≥n: No se pudieron cargar los datos.");
                    } finally {
                        this.cargandoDatos = false;
                    }
                },

                // --- CARGA LAZY ---
                async cargarEstadoTarjetasVista(listaClientes) {
                    for (const cliente of listaClientes) {
                        if (cliente.tarjetasDispositivo !== undefined || cliente.loadingCards) continue;

                        cliente.loadingCards = true;
                        try {
                            const res = await fetch(`/api/cliente/${cliente.CODCLIENTE}/tarjetas`);
                            const data = await res.json();
                            cliente.tarjetasDispositivo = data.tarjetas || [];
                            cliente.tarjetas = data.tarjetas || [];
                        } catch (e) {
                            cliente.tarjetasDispositivo = [];
                        } finally {
                            cliente.loadingCards = false;
                        }
                        await new Promise(r => setTimeout(r, 100));
                    }
                },

                // --- HELPERS ---
                obtenerIniciales(nombre) {
                    if (!nombre) return "??";
                    return nombre.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
                },
                estaVigente(fechaFin) {
                    if (!fechaFin) return true;
                    return new Date(fechaFin) > new Date();
                },
                formatearFecha(fecha) {
                    if (!fecha) return 'Indefinido';
                    return new Date(fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                },

                // --- MODAL ---
                async abrirModal(cliente) {
                    this.clienteSeleccionado = cliente;
                    this.tarjetaInput = '';
                    this.fotoActualUrl = null; // Reiniciamos visualizaci√≥n
                    this.cancelarEspera(); 

                    // Intentar cargar la foto actual (simulado o consulta)
                    // Por ahora reseteamos a null para que salga el placeholder
                    // Si tuvi√©ramos persistencia, aqu√≠ har√≠amos fetch(`/api/cliente/${cliente.CODCLIENTE}/foto`)

                    if (cliente.tarjetasDispositivo !== undefined) {
                        this.clienteSeleccionado.tarjetas = cliente.tarjetasDispositivo;
                        return;
                    }

                    this.cargandoTarjetas = true;
                    try {
                        const res = await fetch(`/api/cliente/${cliente.CODCLIENTE}/tarjetas`);
                        const data = await res.json();
                        cliente.tarjetas = data.tarjetas || [];
                        cliente.tarjetasDispositivo = data.tarjetas;
                    } catch (e) {
                        alert("Error leyendo tarjetas.");
                    } finally {
                        this.cargandoTarjetas = false;
                    }
                },
                cerrarModal() {
                    this.cancelarEspera();
                    this.clienteSeleccionado = null;
                },

                // --- FOTOS: M√âTODOS "AL PASO" ---
                async iniciarCapturaAlPaso() {
                    this.esperandoRostro = true;
                    this.fotoDetectada = null;
                    console.log("üì° Esperando foto del servidor local...");

                    const tiempoInicio = Date.now();
                    const maxEspera = 30000;

                    if(this.pollingInterval) clearInterval(this.pollingInterval); 

                    this.pollingInterval = setInterval(async () => {
                        try {
                            const res = await fetch('/api/eventos/ultimo-local');
                            const evento = await res.json();

                            if (evento && evento.fotoUrl && evento.timestamp > tiempoInicio) {
                                console.log("üì∏ ¬°Foto recibida!", evento.fotoUrl);
                                clearInterval(this.pollingInterval);
                                this.fotoDetectada = {
                                    url: evento.fotoUrl,
                                    originalUrl: evento.fotoUrl
                                };
                                this.esperandoRostro = false;
                            }

                            if (Date.now() - tiempoInicio > maxEspera) {
                                this.cancelarEspera();
                                alert("Tiempo agotado. No se recibi√≥ ninguna foto.");
                            }
                        } catch (e) {
                            console.error("Error consultando local:", e);
                        }
                    }, 1000); 
                },

                cancelarEspera() {
                    if (this.pollingInterval) clearInterval(this.pollingInterval);
                    this.esperandoRostro = false;
                    this.fotoDetectada = null;
                },

                async guardarFotoDetectada() {
                    if (!this.fotoDetectada) return;
                    try {
                        const resBlob = await fetch(this.fotoDetectada.url);
                        const blob = await resBlob.blob();
                        await this._enviarFoto(blob);
                        // Mostrar la foto reci√©n subida
                        this.fotoActualUrl = this.fotoDetectada.url;
                        this.fotoDetectada = null;
                    } catch (e) {
                        alert("Error guardando la foto detectada");
                    }
                },

                // M√©todo de subida manual (INPUT FILE)
                async subirFotoArchivo() {
                    if (!this.$refs.fileInput.files.length) return;
                    const file = this.$refs.fileInput.files[0];
                    await this._enviarFoto(file);
                    
                    // Mostrar la foto reci√©n subida
                    this.fotoActualUrl = URL.createObjectURL(file);
                    this.$refs.fileInput.value = '';
                },

                async _enviarFoto(blob) {
                    const formData = new FormData();
                    formData.append('foto', blob, 'rostro.jpg');

                    try {
                        const res = await fetch(`/api/cliente/${this.clienteSeleccionado.CODCLIENTE}/foto`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert("‚úÖ Foto actualizada correctamente");
                        } else {
                            alert("‚ùå Error: " + data.error);
                        }
                    } catch (e) {
                        alert("Error de red al subir foto");
                    }
                },

                // --- NUEVO: BORRAR FOTO ---
                async borrarFoto() {
                    if (!confirm("¬øEliminar la foto de este cliente del dispositivo?")) return;
                    try {
                        const res = await fetch(`/api/cliente/${this.clienteSeleccionado.CODCLIENTE}/foto`, {
                            method: 'DELETE'
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert("üóëÔ∏è Foto eliminada correctamente.");
                            this.fotoActualUrl = null; // Quitar visualizaci√≥n
                        } else {
                            alert("‚ùå Error: " + (data.error || "No se pudo eliminar"));
                        }
                    } catch (e) {
                        alert("Error de red al eliminar foto");
                    }
                },

                // --- OTROS ---
                async sincronizarTodo() {
                    this.loadingSync = true;
                    if (confirm("Se enviar√°n TODOS los clientes al dispositivo. ¬øContinuar?")) {
                        try {
                            await fetch('/api/sync-all', { method: 'POST' });
                            alert("‚úÖ Sincronizaci√≥n iniciada.");
                        } catch (e) { alert("‚ùå Error: " + e.message); }
                    }
                    this.loadingSync = false;
                },

                async vincularTarjeta() {
                    const t = this.tarjetaInput.trim();
                    if (t.length < 1 || t.length > 20) return alert("Longitud inv√°lida");
                    if (this.clienteSeleccionado.tarjetas.includes(t)) return alert("Tarjeta duplicada");
                    if (this.clienteSeleccionado.tarjetas.length >= 5) return alert("M√°ximo 5 tarjetas");

                    try {
                        const res = await fetch(`/api/cliente/${this.clienteSeleccionado.CODCLIENTE}/tarjeta`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tarjeta: t })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.clienteSeleccionado.tarjetas.push(t);
                            this.clienteSeleccionado.tarjetasDispositivo = this.clienteSeleccionado.tarjetas;
                            this.tarjetaInput = '';
                        } else alert("‚ùå Error: " + data.error);
                    } catch (e) { alert("Error de red"); }
                },

                async eliminarTarjeta(card) {
                    if (!confirm("¬øEliminar tarjeta?")) return;
                    try {
                        const res = await fetch(`/api/cliente/${this.clienteSeleccionado.CODCLIENTE}/tarjeta/${card}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            this.clienteSeleccionado.tarjetas = this.clienteSeleccionado.tarjetas.filter(x => x !== card);
                            this.clienteSeleccionado.tarjetasDispositivo = this.clienteSeleccionado.tarjetas;
                        } else alert("‚ùå Error: " + data.error);
                    } catch (e) { alert("Error de red"); }
                },

                cambiarPagina(p) {
                    if (p >= 1 && p <= this.totalPaginas) this.paginaActual = p;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>